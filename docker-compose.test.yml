version: '3.8'

services:
  # Kafka Setup
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    hostname: zookeeper
    container_name: test-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_LOG4J_ROOT_LOGLEVEL: WARN
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    hostname: kafka
    container_name: test-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - test-network

  # Elasticsearch Setup
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: test-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - logger.level=WARN
    ports:
      - "9200:9200"
      - "9300:9300"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - test-network
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data

  # MinIO (S3-compatible storage)
  minio:
    image: minio/minio:latest
    container_name: test-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network
    volumes:
      - minio-data:/data

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: test-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/logs --ignore-existing;
      mc mb myminio/test-logs --ignore-existing;
      mc mb myminio/backup --ignore-existing;
      echo 'MinIO buckets created successfully';
      exit 0;
      "
    networks:
      - test-network

  # Prometheus for metrics testing
  prometheus:
    image: prom/prometheus:latest
    container_name: test-prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--log.level=warn'
    volumes:
      - ./test/config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - test-network

  # Jaeger for tracing testing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: test-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=warn
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
      - "14268:14268"  # Jaeger collector HTTP
    networks:
      - test-network

  # Redis for caching/state testing
  redis:
    image: redis:7-alpine
    container_name: test-redis
    ports:
      - "6379:6379"
    command: redis-server --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network
    volumes:
      - redis-data:/data

  # Log aggregator service (the application under test)
  log-aggregator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: test-log-aggregator
    depends_on:
      kafka:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"   # HTTP input
      - "514:514/udp" # Syslog
      - "9091:9090"   # Metrics
      - "8081:8081"   # Health
    environment:
      - LOG_LEVEL=debug
      - KAFKA_BROKERS=kafka:9092
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=logs
      - REDIS_ADDR=redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    volumes:
      - ./test/config/config.test.yaml:/etc/log-aggregator/config.yaml:ro
      - ./test/data:/test/data
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Chaos testing controller (for network partitions, pod kills, etc.)
  chaos-controller:
    image: nicolaka/netshoot:latest
    container_name: test-chaos-controller
    privileged: true
    depends_on:
      log-aggregator:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./test/chaos:/chaos:ro
    command: sleep infinity
    networks:
      - test-network

  # Load generator for stress testing
  load-generator:
    build:
      context: .
      dockerfile: Dockerfile.loadtest
    container_name: test-load-generator
    depends_on:
      log-aggregator:
        condition: service_healthy
    environment:
      - TARGET_URL=http://log-aggregator:8080
      - RATE=1000
      - DURATION=300s
      - WORKERS=10
    volumes:
      - ./test/results:/results
    networks:
      - test-network
    profiles:
      - load-test

networks:
  test-network:
    driver: bridge

volumes:
  elasticsearch-data:
  minio-data:
  prometheus-data:
  redis-data:
